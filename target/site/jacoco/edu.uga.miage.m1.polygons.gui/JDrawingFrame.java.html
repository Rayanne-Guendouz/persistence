<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JDrawingFrame.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Persistence_g1_8</a> &gt; <a href="index.source.html" class="el_package">edu.uga.miage.m1.polygons.gui</a> &gt; <span class="el_source">JDrawingFrame.java</span></div><h1>JDrawingFrame.java</h1><pre class="source lang-java linenums">package edu.uga.miage.m1.polygons.gui;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.awt.event.MouseMotionListener;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;

import javax.swing.ImageIcon;
import javax.swing.JButton;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JToolBar;

import java.awt.*;

import edu.uga.miage.m1.polygons.gui.commands.GoBack;
import edu.uga.miage.m1.polygons.gui.persistence.JSonVisitor;
import edu.uga.miage.m1.polygons.gui.persistence.Visitable;
import edu.uga.miage.m1.polygons.gui.persistence.XMLVisitor;
import edu.uga.miage.m1.polygons.gui.shapes.Circle;
import edu.uga.miage.m1.polygons.gui.shapes.SimpleShape;
import edu.uga.miage.m1.polygons.gui.shapes.Square;
import edu.uga.miage.m1.polygons.gui.shapes.Triangle;

/**
 * This class represents the main application class, which is a JFrame subclass
 * that manages a toolbar of shapes and a drawing canvas.
 *
 * @author &lt;a href=&quot;mailto:christophe.saint-marcel@univ-grenoble-alpes.fr&quot;&gt;Christophe&lt;/a&gt;
 */
public class JDrawingFrame extends JFrame implements MouseListener, MouseMotionListener,KeyListener {

<span class="fc" id="L45">    public enum Shapes {</span>

<span class="fc" id="L47">        SQUARE, TRIANGLE, CIRCLE</span>
    }

    private static final long serialVersionUID = 1L;

    private JToolBar m_toolbar;

    private Shapes m_selected;

    public JPanel m_panel;

    private JLabel m_label;

<span class="fc" id="L60">    private ActionListener m_reusableActionListener = new ShapeActionListener();</span>


    /**
     * Tracks buttons to manage the background.
     */
<span class="fc" id="L66">    public Map&lt;Shapes, JButton&gt; m_buttons = new HashMap&lt;&gt;();</span>

    /**
     * Default constructor that populates the main window.
     * @param frameName
     */
    // Liste des objets visitable
<span class="fc" id="L73">    public ArrayList&lt;Visitable&gt; shapesList = new ArrayList&lt;Visitable&gt;();</span>

    // Controller Command
<span class="fc" id="L76">    private RemoteControl remoteControl = new RemoteControl();</span>

    // Liste des objets SimpleSHape 
<span class="fc" id="L79">    private ArrayList&lt;SimpleShape&gt; simpleShapes = new ArrayList&lt;SimpleShape&gt;();</span>

<span class="fc" id="L81">    private long lastCtrlZPressTime = 0;</span>
    private static final long CTRL_Z_DELAY = 500; // DÃ©lai d'attente en millisecondes (1 seconde ici)

    public JDrawingFrame(String frameName) {
<span class="fc" id="L85">        super(frameName);</span>
        // Instantiates components
<span class="fc" id="L87">        m_toolbar = new JToolBar(&quot;Toolbar&quot;);</span>
<span class="fc" id="L88">        m_panel = new JPanel();</span>
<span class="fc" id="L89">        m_panel.setBackground(Color.WHITE);</span>
<span class="fc" id="L90">        m_panel.setLayout(null);</span>
<span class="fc" id="L91">        m_panel.setMinimumSize(new Dimension(400, 400));</span>
<span class="fc" id="L92">        m_panel.addMouseListener(this);</span>
<span class="fc" id="L93">        m_panel.addMouseMotionListener(this);</span>
<span class="fc" id="L94">        m_label = new JLabel(&quot; &quot;, JLabel.LEFT);</span>
        // Initialisation de shapesList
<span class="fc" id="L96">        shapesList = new ArrayList&lt;Visitable&gt;();</span>
        // Fills the panel
<span class="fc" id="L98">        setLayout(new BorderLayout());</span>
<span class="fc" id="L99">        add(m_toolbar, BorderLayout.NORTH);</span>
<span class="fc" id="L100">        add(m_panel, BorderLayout.CENTER);</span>
<span class="fc" id="L101">        add(m_label, BorderLayout.SOUTH);</span>
        // Add shapes in the menu
<span class="fc" id="L103">        addShape(Shapes.SQUARE, new ImageIcon(getClass().getResource(&quot;images/square.png&quot;)));</span>
<span class="fc" id="L104">        addShape(Shapes.TRIANGLE, new ImageIcon(getClass().getResource(&quot;images/triangle.png&quot;)));</span>
<span class="fc" id="L105">        addShape(Shapes.CIRCLE, new ImageIcon(getClass().getResource(&quot;images/circle.png&quot;)));</span>
        // Ajout du bouton Sauvegarder
<span class="fc" id="L107">        JButton sauvegarderButton = new JButton(&quot;Sauvegarder&quot;);</span>
<span class="fc" id="L108">        m_toolbar.add(sauvegarderButton);</span>
        // ActionListener pour le bouton Sauvegarder
<span class="fc" id="L110">        sauvegarderButton.addActionListener(new SauvegardeActionListener());</span>
<span class="fc" id="L111">        setPreferredSize(new Dimension(400, 400));</span>
        // Ajout du KeyListener pour dÃÂ©tecter &quot;Ctrl+Z&quot;
<span class="fc" id="L113">        addKeyListener(this);</span>
<span class="fc" id="L114">        setFocusable(true);</span>
<span class="fc" id="L115">        setFocusTraversalKeysEnabled(true);</span>
        // Ajoutez un gestionnaire de focus pour gÃ©rer le focus entre les composants
<span class="fc" id="L117">        KeyboardFocusManager.getCurrentKeyboardFocusManager().addKeyEventDispatcher(new KeyEventController());</span>
<span class="fc" id="L118">    }</span>

    /**
     * Injects an available &lt;tt&gt;SimpleShape&lt;/tt&gt; into the drawing frame.
     * @param name The name of the injected &lt;tt&gt;SimpleShape&lt;/tt&gt;.
     * @param icon The icon associated with the injected &lt;tt&gt;SimpleShape&lt;/tt&gt;.
     */
    public void addShape(Shapes shape, ImageIcon icon) {
<span class="fc" id="L126">        JButton button = new JButton(icon);</span>
<span class="fc" id="L127">        button.setBorderPainted(false);</span>
<span class="fc" id="L128">        m_buttons.put(shape, button);</span>
<span class="fc" id="L129">        button.setActionCommand(shape.toString());</span>
<span class="fc" id="L130">        button.addActionListener(m_reusableActionListener);</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">        if (m_selected == null) {</span>
<span class="fc" id="L132">            button.doClick();</span>
        }
<span class="fc" id="L134">        m_toolbar.add(button);</span>
<span class="fc" id="L135">        m_toolbar.validate();</span>
<span class="fc" id="L136">        repaint();</span>
<span class="fc" id="L137">    }</span>

    /**
     * Implements method for the &lt;tt&gt;MouseListener&lt;/tt&gt; interface to
     * draw the selected shape into the drawing canvas.
     * @param evt The associated mouse event.
     */
    public void mouseClicked(MouseEvent evt) {
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">        if (m_panel.contains(evt.getX(), evt.getY())) {</span>
<span class="nc" id="L146">            Graphics2D g2 = (Graphics2D) m_panel.getGraphics();</span>
<span class="nc bnc" id="L147" title="All 4 branches missed.">            switch(m_selected) {</span>
                case CIRCLE:
<span class="nc" id="L149">                    Circle circle = new Circle(evt.getX(), evt.getY());</span>
<span class="nc" id="L150">                    circle.draw(g2);</span>
                    // Ajout de l'objet dans la liste
<span class="nc" id="L152">                    shapesList.add(circle);</span>
<span class="nc" id="L153">                    simpleShapes.add(circle);</span>
<span class="nc" id="L154">                    break;</span>
                case TRIANGLE:
<span class="nc" id="L156">                    Triangle triangle = new Triangle(evt.getX(), evt.getY());</span>
<span class="nc" id="L157">                    triangle.draw(g2);</span>
                    // Ajout de l'objet dans la liste
<span class="nc" id="L159">                    shapesList.add(triangle);</span>
<span class="nc" id="L160">                    simpleShapes.add(triangle);</span>
<span class="nc" id="L161">                    break;</span>
                case SQUARE:
<span class="nc" id="L163">                    Square square = new Square(evt.getX(), evt.getY());</span>
<span class="nc" id="L164">                    square.draw(g2);</span>
                    // Ajout de l'objet dans la liste
<span class="nc" id="L166">                    shapesList.add(square);</span>
<span class="nc" id="L167">                    simpleShapes.add(square);</span>
<span class="nc" id="L168">                    break;</span>
                default:
<span class="nc" id="L170">                    System.out.println(&quot;No shape named &quot; + m_selected);</span>
            }
        }
<span class="fc" id="L173">    }</span>

    /**
     * Implements an empty method for the &lt;tt&gt;MouseListener&lt;/tt&gt; interface.
     * @param evt The associated mouse event.
     */
    public void mouseEntered(MouseEvent evt) {
<span class="nc" id="L180">    }</span>

    /**
     * Implements an empty method for the &lt;tt&gt;MouseListener&lt;/tt&gt; interface.
     * @param evt The associated mouse event.
     */
    public void mouseExited(MouseEvent evt) {
<span class="nc" id="L187">        m_label.setText(&quot; &quot;);</span>
<span class="nc" id="L188">        m_label.repaint();</span>
<span class="nc" id="L189">    }</span>

    /**
     * Implements method for the &lt;tt&gt;MouseListener&lt;/tt&gt; interface to initiate
     * shape dragging.
     * @param evt The associated mouse event.
     */
    public void mousePressed(MouseEvent evt) {
<span class="nc" id="L197">    }</span>

    /**
     * Implements method for the &lt;tt&gt;MouseListener&lt;/tt&gt; interface to complete
     * shape dragging.
     * @param evt The associated mouse event.
     */
    public void mouseReleased(MouseEvent evt) {
<span class="nc" id="L205">    }</span>

    /**
     * Implements method for the &lt;tt&gt;MouseMotionListener&lt;/tt&gt; interface to
     * move a dragged shape.
     * @param evt The associated mouse event.
     */
    public void mouseDragged(MouseEvent evt) {
<span class="nc" id="L213">    }</span>

    /**
     * Implements an empty method for the &lt;tt&gt;MouseMotionListener&lt;/tt&gt;
     * interface.
     * @param evt The associated mouse event.
     */
    public void mouseMoved(MouseEvent evt) {
<span class="nc" id="L221">        modifyLabel(evt);</span>
<span class="nc" id="L222">    }</span>

    private void modifyLabel(MouseEvent evt) {
<span class="nc" id="L225">        m_label.setText(&quot;(&quot; + evt.getX() + &quot;,&quot; + evt.getY() + &quot;)&quot;);</span>
<span class="nc" id="L226">    }</span>

    /**
     * Simple action listener for shape tool bar buttons that sets
     * the drawing frame's currently selected shape when receiving
     * an action event.
     */
<span class="fc" id="L233">    private class ShapeActionListener implements ActionListener {</span>

        public void actionPerformed(ActionEvent evt) {
            // ItÃÂ¨re sur tous les boutons
<span class="fc" id="L237">            Iterator&lt;Shapes&gt; keys = m_buttons.keySet().iterator();</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">            while (keys.hasNext()) {</span>
<span class="fc" id="L239">                Shapes shape = keys.next();</span>
<span class="fc" id="L240">                JButton btn = m_buttons.get(shape);</span>
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">                if (evt.getActionCommand().equals(shape.toString())) {</span>
<span class="fc" id="L242">                    btn.setBorderPainted(true);</span>
<span class="fc" id="L243">                    m_selected = shape;</span>
                } else {
<span class="nc" id="L245">                    btn.setBorderPainted(false);</span>
                }
<span class="fc" id="L247">                btn.repaint();</span>
<span class="fc" id="L248">            }</span>
<span class="fc" id="L249">        }</span>
    }
    
    // La fonction de sauvegarde
<span class="fc" id="L253">    public class SauvegardeActionListener implements ActionListener {</span>

        public void actionPerformed(ActionEvent e) {
<span class="fc" id="L256">                String jsonData = &quot;{\n  \&quot;shapes\&quot;: [\n&quot;;</span>
<span class="fc" id="L257">                String xmlData = &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot; ?&gt;\r\n&quot; + //</span>
                        &quot;&lt;root&gt;\r\n&quot; + //
                        &quot;&lt;shapes&gt;\n&quot;;
                // ItÃÂ¨re sur tous les objets
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">                for (Visitable shape : shapesList) {</span>
                    // DonnÃÂ©e de sauvegarde XML
<span class="nc" id="L263">                    XMLVisitor xmlVisitor = new XMLVisitor();</span>
                    // DonnÃÂ©e de sauvegarde JSON
<span class="nc" id="L265">                    JSonVisitor jsonVisitor = new JSonVisitor();</span>
                    // Sauvegarde en JSON
<span class="nc" id="L267">                    shape.accept(jsonVisitor);</span>
<span class="nc" id="L268">                    jsonData += &quot;   &quot; + jsonVisitor.getRepresentation();</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">                    if (shapesList.indexOf(shape) &lt; shapesList.size() - 1) {</span>
<span class="nc" id="L270">                        jsonData += &quot;,&quot;;</span>
                    }
<span class="nc" id="L272">                    jsonData += &quot;\n&quot;;</span>
                    // Sauvegarde en XML
<span class="nc" id="L274">                    shape.accept(xmlVisitor);</span>
<span class="nc" id="L275">                    xmlData += &quot;    &quot; + xmlVisitor.getRepresentation() + &quot;\n&quot;;</span>
<span class="nc" id="L276">                }</span>
                // Imprime le JSON
<span class="fc" id="L278">                jsonData += &quot;  ]\n}&quot;;</span>
                // Imprime le XML
<span class="fc" id="L280">                xmlData += &quot;&lt;/shapes&gt;\r\n&lt;/root&gt;&quot;;</span>

<span class="fc" id="L282">                String cheminFichierJSON = &quot;src/main/java/edu/uga/miage/m1/polygons/gui/save/Save.json&quot;; </span>
<span class="fc" id="L283">                String cheminFichierXML = &quot;src/main/java/edu/uga/miage/m1/polygons/gui/save/Save.xml&quot;; </span>

<span class="fc" id="L285">                try (BufferedWriter jsonWriter = new BufferedWriter(new FileWriter(new File(cheminFichierJSON)));</span>
<span class="fc" id="L286">                    BufferedWriter xmlWriter = new BufferedWriter(new FileWriter(new File(cheminFichierXML)))) {</span>
<span class="fc" id="L287">                    jsonWriter.write(jsonData);</span>
<span class="fc" id="L288">                    xmlWriter.write(xmlData);</span>
<span class="nc" id="L289">                } catch (IOException ex) {</span>
<span class="nc" id="L290">                    ex.printStackTrace();</span>
<span class="fc" id="L291">                }</span>
<span class="fc" id="L292">            }</span>
    }
    
    // La classe qui gÃ¨re les entree clavier
<span class="fc" id="L296">    private class KeyEventController implements KeyEventDispatcher {</span>
        @Override
        public boolean dispatchKeyEvent(KeyEvent e) {
<span class="nc bnc" id="L299" title="All 4 branches missed.">            if (e.isControlDown() &amp;&amp; e.getKeyCode() == KeyEvent.VK_Z) {</span>
<span class="nc" id="L300">                long currentTime = System.currentTimeMillis();</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">                if (currentTime - lastCtrlZPressTime &gt;= CTRL_Z_DELAY) {</span>
<span class="nc" id="L302">                    remoteControl.addCommand(new GoBack(JDrawingFrame.this));</span>
<span class="nc" id="L303">                    lastCtrlZPressTime = currentTime;</span>
                }
            }
<span class="nc" id="L306">            remoteControl.play();</span>
<span class="nc" id="L307">            remoteControl.reset();</span>
<span class="nc" id="L308">            return false;</span>
        }
    }

    // La fonction pour revenir en arriÃ¨re
    public void goBack() {
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">        if (!shapesList.isEmpty()) {</span>
<span class="nc" id="L315">            shapesList.remove(shapesList.size() - 1); // Supprime la derniÃÂ¨re forme</span>
<span class="nc" id="L316">            simpleShapes.remove(simpleShapes.size()-1); // SUpprime la derniÃ¨re forme</span>
            // Efface le panneau
<span class="nc" id="L318">            Graphics2D g2 = (Graphics2D) m_panel.getGraphics();</span>
<span class="nc" id="L319">            g2.setColor(Color.WHITE);</span>
<span class="nc" id="L320">            g2.fillRect(0, 0, m_panel.getWidth(), m_panel.getHeight());</span>
            // Redessine toutes les formes restantes
<span class="nc bnc" id="L322" title="All 2 branches missed.">            for (SimpleShape shape : simpleShapes) {</span>
<span class="nc" id="L323">                shape.draw(g2);</span>
<span class="nc" id="L324">            }</span>
        }
<span class="fc" id="L326">    }</span>

    @Override
    public void keyPressed(KeyEvent e) {
<span class="nc" id="L330">    }</span>

    @Override
    public void keyReleased(KeyEvent e) {
<span class="nc" id="L334">    }</span>

    @Override
    public void keyTyped(KeyEvent e) {
<span class="nc" id="L338">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>